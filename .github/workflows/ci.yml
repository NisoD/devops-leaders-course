name: CI Pipeline (Session 2)

on:
  workflow_dispatch:
  push:
    branches: [session2-daniel]
jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-venv

    - name: Set up Python environment and install dependencies
      run: |
        python -m venv venv
        source venv/bin/activate

        pip install --upgrade pip
        pip install -r requirements.txt

        # CI-specific tools
        pip install pytest httpx black bandit pip-audit detect-secrets

    - name: Run test and static analysis suite
      run: |
        source venv/bin/activate
        chmod +x run_tests.sh
        ./run_tests.sh

    - name: Verify application starts
      run: |
        source venv/bin/activate
        echo "Verifying application can start..."
        uvicorn main:app --host 127.0.0.1 --port 8000 --no-access-log &
        APP_PID=$!

        sleep 5

        if ps -p $APP_PID > /dev/null; then
            echo "Application started successfully"
            kill $APP_PID
        else
            echo "Application failed to start"
            exit 1
        fi
